<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Web Crawl Agent</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        line-height: 1.5;
        color: #0f172a;
        background: #eef1f6;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        padding: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      main {
        width: min(1100px, 100%);
        background: #ffffff;
        border-radius: 24px;
        padding: 2.5rem;
        box-shadow: 0 25px 60px rgba(15, 23, 42, 0.08);
        border: 1px solid #e5eaf2;
      }

      .hero {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 1.25rem;
        margin-bottom: 1.75rem;
      }

      .hero h1 {
        margin: 0;
        font-size: clamp(1.8rem, 2.6vw, 2.6rem);
        color: #0b1120;
      }

      .hero p {
        margin: 0.35rem 0 0;
        color: #475569;
      }

      .hero-meta {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: #475569;
      }

      .hero-meta span {
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        font-size: 0.85rem;
        border: 1px solid #cfd8e6;
        background: #f5f7fb;
      }

      form {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 0.75rem;
        margin-bottom: 2rem;
      }

      input[type="url"] {
        border-radius: 999px;
        border: 1px solid #d6dbe7;
        padding: 0.95rem 1.3rem;
        font-size: 1rem;
        background: #f9fbff;
        transition: border-color 0.2s ease;
      }

      input[type="url"]:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 0.95rem 1.8rem;
        background: #2563eb;
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.1s ease;
      }

      button:hover {
        background: #1f4ed8;
      }

      button:active {
        transform: translateY(1px);
      }

      .layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1.1fr);
        gap: 1.5rem;
      }

      .panel {
        border: 1px solid #e5eaf2;
        border-radius: 20px;
        padding: 1.5rem;
        background: #fdfefe;
      }

      #conversation {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        max-height: 420px;
        overflow-y: auto;
      }

      .bubble {
        padding: 0.85rem 1rem;
        border-radius: 12px;
        width: fit-content;
        max-width: 85%;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.05);
        border: 1px solid #e2e8f0;
      }

      .bubble strong {
        display: block;
        font-size: 0.78rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 0.25rem;
        color: #94a3b8;
      }

      .user {
        align-self: flex-end;
        background: #1e3a8a;
        color: #f8fafc;
        border-color: #1e3a8a;
      }

      .agent {
        align-self: flex-start;
        background: #ffffff;
      }

      #summary-card {
        background: #ffffff;
      }

      #summary-card[hidden] {
        display: none;
      }

      .summary-header {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1.25rem;
      }

      .summary-header h2 {
        margin: 0;
      }

      .summary-grid {
        display: grid;
        gap: 1.25rem;
      }

      .summary-section {
        border: 1px solid #e5eaf2;
        border-radius: 14px;
        padding: 1rem;
        background: #f9fbff;
      }

      .summary-section h3,
      .summary-section h2 {
        margin: 0 0 0.5rem;
        color: #0f172a;
      }

      ul {
        margin: 0;
        padding-left: 1.2rem;
        color: #475569;
      }

      #metrics li {
        font-size: 0.95rem;
      }

      a.download {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
        text-decoration: none;
        color: #1d4ed8;
        font-weight: 600;
      }

      a.download::before {
        content: "⬇";
      }

      @media (max-width: 900px) {
        body {
          padding: 1rem;
        }

        main {
          padding: 1.5rem;
        }

        .layout {
          grid-template-columns: 1fr;
        }

        form {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="hero">
        <div>
          <h1>Web Crawl Agent</h1>
          <p>Audit any site, capture structured insights, and export polished PDFs.</p>
        </div>
        <div class="hero-meta">
          <span>Headless Chromium</span>
          <span>Live LLM Summaries</span>
        </div>
      </header>

      <form id="crawl-form">
        <input type="url" id="url-input" placeholder="https://example.com" required />
        <button type="submit">Analyze</button>
      </form>

      <div class="layout">
        <section class="panel">
          <h2 style="margin-top:0;margin-bottom:0.75rem;">Conversation</h2>
          <p style="margin:0 0 1.25rem;color:#64748b;">Live status feed from the crawler.</p>
          <div id="conversation"></div>
        </section>

        <section id="summary-card" class="panel" hidden>
          <div class="summary-header">
            <div>
              <h2 style="margin:0;">Summary</h2>
              <p style="margin:0;color:#64748b;">LLM-generated briefing & crawl metrics</p>
            </div>
            <a id="download-link" class="download" href="#" target="_blank">Download PDF</a>
          </div>

          <div class="summary-grid">
            <div class="summary-section">
              <h3>Overview</h3>
              <p id="overview" style="margin:0;color:#475569;"></p>
            </div>
            <div class="summary-section">
              <h3>Key Sections</h3>
              <ul id="sections"></ul>
            </div>
            <div class="summary-section">
              <h3>Highlights</h3>
              <ul id="highlights"></ul>
            </div>
            <div class="summary-section">
              <h3>Recommendations</h3>
              <ul id="recommendations"></ul>
            </div>
            <div class="summary-section">
              <h3>Metrics</h3>
              <ul id="metrics"></ul>
            </div>
          </div>
        </section>
      </div>
    </main>

    <script>
      const form = document.getElementById('crawl-form');
      const urlInput = document.getElementById('url-input');
      const convo = document.getElementById('conversation');
      const summaryCard = document.getElementById('summary-card');
      const overviewEl = document.getElementById('overview');
      const sectionsEl = document.getElementById('sections');
      const highlightsEl = document.getElementById('highlights');
      const recommendationsEl = document.getElementById('recommendations');
      const metricsEl = document.getElementById('metrics');
      const downloadLink = document.getElementById('download-link');

      let source;

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const url = urlInput.value.trim();
        if (!url) return;
        addBubble('You', url, 'user');
        startStream(url);
      });

      function startStream(url) {
        summaryCard.hidden = true;
        metricsEl.innerHTML = '';
        sectionsEl.innerHTML = '';
        highlightsEl.innerHTML = '';
        recommendationsEl.innerHTML = '';
        overviewEl.textContent = '';
        if (source) {
          source.close();
        }
        addBubble('Agent', 'Starting crawl...', 'agent');
        source = new EventSource(`/api/stream?url=${encodeURIComponent(url)}`);
        source.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'status') {
            addBubble('Agent', data.message, 'agent');
          } else if (data.type === 'summary') {
            renderSummary(data);
            addBubble('Agent', 'Summary complete ✅', 'agent');
            source.close();
          } else if (data.type === 'error') {
            addBubble('Agent', `Error: ${data.message}`, 'agent');
            source.close();
          }
        };
        source.onerror = () => {
          addBubble('Agent', 'Connection lost. Please retry.', 'agent');
          source.close();
        };
      }

      function addBubble(author, message, cls) {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${cls}`;
        bubble.innerHTML = `<strong>${author}</strong>${message}`;
        convo.appendChild(bubble);
        convo.scrollTop = convo.scrollHeight;
      }

      function renderSummary(data) {
        const { summary, metrics, pdf_path } = data;
        overviewEl.textContent = summary.overview;
        populateList(sectionsEl, summary.sections);
        populateList(highlightsEl, summary.highlights);
        populateList(recommendationsEl, summary.recommendations);
        populateList(metricsEl, [
          `Pages crawled: ${metrics.total_pages}`,
          `Internal links: ${metrics.internal_links}`,
          `External links: ${metrics.external_links}`,
          `Top headings: ${metrics.top_headings.join(', ')}`,
          `Keywords: ${metrics.keywords.join(', ')}`,
        ]);
        downloadLink.href = pdf_path;
        summaryCard.hidden = false;
      }

      function populateList(node, items) {
        node.innerHTML = '';
        items.forEach((item) => {
          const li = document.createElement('li');
          li.textContent = item;
          node.appendChild(li);
        });
      }
    </script>
  </body>
</html>
